<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Gopal</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://unpkg.com/xlsx/dist/xlsx.full.min.js"></script>
    <script src="https://unpkg.com/tabulator-tables@5.5.0/dist/js/tabulator.min.js"></script>    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.29/jspdf.plugin.autotable.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css" rel="stylesheet">  
    <link href="https://fonts.googleapis.com/css2?family=Roboto+Mono&display=swap" rel="stylesheet">
    <link href="https://unpkg.com/tabulator-tables@5.5.0/dist/css/tabulator.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
</head>
<body class="min-h-screen bg-gray-900 text-white text-[16px]" style="font-family: 'Poppins', sans-serif;">
<header id="topbar" class="w-full bg-gray-800 hover:bg-blue-800 text-green-500 px-5 py-3 cursor-pointer text-[20px]">Inventory App</header>
<nav id="top-nav" class="fixed top-[-1px] left-0 h-[670px] w-full bg-gray-900 transform -translate-y-full transition-transform duration-300 z-50 overflow-y-auto">
    <ul>
        <li><a class="block hover:bg-lime-800 px-2 py-3 cursor-pointer menu-link bg-gray-800" id="close">Home</a></li>
        <li><a class="block hover:bg-lime-800 px-2 py-3 cursor-pointer menu-link" onclick="showCont('tranCont')">Transaction</a></li>
        <li><a class="block hover:bg-lime-800 px-2 py-3 cursor-pointer menu-link" onclick="insertTran()">Update Transaction</a></li>
        <li><a class="block hover:bg-lime-800 px-2 py-3 cursor-pointer menu-link" onclick="viewStock()">View Stock</a></li>
        <li><a class="block hover:bg-lime-800 px-2 py-3 cursor-pointer menu-link" onclick="viewDeptCons()">View Deptwise</a></li>
        <li><a class="block hover:bg-lime-800 px-2 py-3 cursor-pointer menu-link" onclick="viewCatgwiseStock()">View Catgwise Stock</a></li>
    </ul>
</nav>

<div id="lgnCont" class="hidden w-full max-w-md p-1 mt-200 rounded-b-2xl bg-gray-900">
    <div class="relative mt-6"><input id="loginEmail" class="input-box" type="email"/><label for="loginEmail" class="label">Email</label></div>
    <div class="relative mt-6"><input id="loginPassword" class="input-box" type="password"/><label for="loginPassword" class="label">Password</label></div>
    <button class="block mx-auto mt-10 px-5 py-2 bg-green-700 hover:bg-green-600 rounded-lg" onclick="login()">üè†Ô∏é Login</button>
</div>

<div id="tranCont" class="hidden max-w-md p-1">
    <div id="ttypeDiv" class="relative mt-6"><input id="ttype1" class="input-box" type="text"/><label for="ttype1" class="label">In or Out</label></div>
    <div id="dateDiv" class="relative mt-6"><input id="date1" class="input-box date-input" type="date"/><label for="date1" class="label">Date</label></div>
    <div id="suppDiv" class="relative mt-6"><input id="supp1" class="input-box" type="text"/><label for="supp1" class="label">Supplier</label><button class="absolute right-1 text-green-500" onclick="showCont('tranCont', 'suppCont')">‚úö</button></div>
    <div id="deptDiv" class="relative mt-6"><input id="dept1" class="input-box" type="text"/><label for="dept1" class="label">Department</label><button class="absolute right-1 text-green-500" onclick="showCont('tranCont', 'deptCont')">‚úö</button></div>
    <div id="catgDiv" class="relative mt-6"><input id="catg1" class="input-box" type="text"/><label for="catg1" class="label">Category</label><button class="absolute right-1 text-green-500" onclick="showCont('tranCont', 'catgCont')">‚úö</button></div>
    <div id="itemDiv" class="relative mt-6"><input id="item1" class="input-box" type="text"/><label for="item1" class="label">Item</label><button class="absolute right-1 text-green-500" onclick="showCont('tranCont', 'itemCont')">‚úö</button></div>
    <div id="pricDiv" class="relative mt-6"><input id="pric1" class="input-box" type="number"/><label for="pric1" class="label">Purchase Price</label></div>
    <div id="qtyDiv" class="relative mt-6"><input id="qty1" class="input-box" type="number"/><label for="qty1" class="label">Quantity</label></div>
    <div id="narDiv" class="relative mt-6"><input id="nar1" class="input-box" type="text"/><label for="nar1" class="label">Narration</label></div>
    <button id="btnDiv" class="w-full mt-20 px-10 py-2 bg-green-700 hover:bg-green-600 rounded-lg" onclick="saveTran()">Save</button>

    <div id="suppCont" class="hidden w-full max-w-md p-1 fixed top-0 mt-[200px] z-50 bg-white rounded-lg">
        <div class="relative mt-6"><input id="suppname" class="input-box text-black" type="text"/><label for="suppname" class="label">New Supplier Name</label></div>
        <button class="block mx-auto mt-7 mb-3 px-10 py-2 bg-green-700 hover:bg-green-600 rounded-lg" onclick="saveCDSI('suppname')">Save</button>
        <button class="mx-auto mt-7 mb-3 px-10 py-2 bg-purple-700 hover:bg-purple-600 rounded-lg" onclick="showCont('tranCont')">Close</button>
    </div>
    <div id="deptCont" class="hidden w-full max-w-md p-1 fixed top-0 mt-[200px] z-50 bg-white rounded-lg">
        <div class="relative mt-6"><input id="deptname" class="input-box text-black" type="text"/><label for="deptname" class="label">New Department Name</label></div>
        <button class="block mx-auto mt-7 mb-3 px-10 py-2 bg-green-700 hover:bg-green-600 rounded-lg" onclick="saveCDSI('deptname')">Save</button>
        <button class="mx-auto mt-7 mb-3 px-10 py-2 bg-purple-700 hover:bg-purple-600 rounded-lg" onclick="showCont('tranCont')">Close</button>
    </div>
    <div id="catgCont" class="hidden w-full max-w-md p-1 fixed top-0 mt-[200px] z-50 bg-white rounded-lg">
        <div class="relative mt-6"><input id="catgname" class="input-box text-black" type="text"/><label for="catgname" class="label">New Category Name</label></div>
        <button class="block mx-auto mt-7 mb-3 px-10 py-2 bg-green-700 hover:bg-green-600 rounded-lg" onclick="saveCDSI('catgname')">Save</button>
        <button class="mx-auto mt-7 mb-3 px-10 py-2 bg-purple-700 hover:bg-purple-600 rounded-lg" onclick="showCont('tranCont')">Close</button>
    </div>
    <div id="itemCont" class="hidden w-full max-w-md p-1 fixed top-0 mt-[150px] z-50 bg-white rounded-lg">
        <div class="relative mt-6"><input id="catggrp" class="input-box text-black" type="text"/><label for="catggrp" class="label">Category</label></div>
        <div class="relative mt-6"><input id="itemname" class="input-box text-black" type="text"/><label for="itemname" class="label">Item Name</label></div>
        <div class="relative mt-6"><input id="loc" class="input-box text-black" type="text"/><label for="loc" class="label">Location(Store3,Shelf2,Rack6....)</label></div>
        <button class="block mx-auto mt-7 mb-3 px-10 py-2 bg-green-700 hover:bg-green-600 rounded-lg" onclick="saveCDSI('itemname')">Save</button>
        <button class="mx-auto mt-7 mb-3 px-10 py-2 bg-purple-700 hover:bg-purple-600 rounded-lg" onclick="showCont('tranCont')">Close</button>
    </div>
</div>

<div id="tblCont" class="hidden w-full p-1 rounded-b-2xl bg-gray-900">
    <button class="bg-green-800  min-w-[113px] h-10 rounded-lg" id="excelBtn">Excel</button>
    <button class="bg-red-800 min-w-[113px] h-10 rounded-lg" id="pdfBtn">PDF</button>
    <button class="bg-blue-800 min-w-[113px] h-10 rounded-lg" id="printBtn">üñ®Ô∏è</button>
    <input class="w-full max-w-[348px] px-2 mt-1 mb-1 h-10 bg-gray-900 border border-blue-600 rounded-lg" id="searchBox" placeholder="Search..." type="text" autocomplete="off"/>
    <div class="overflow-x-auto"><div id="table" class="rounded-lg mx-auto text-[18px] font-[Roboto]"></div></div>
</div>

<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<script type="module">
    import {initializeApp} 
    from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import {getAuth, onAuthStateChanged, signInWithEmailAndPassword, signOut,} 
    from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
    import {getFirestore, collection, getDocs, getDoc, doc, deleteDoc, updateDoc, query, where, addDoc, writeBatch, onSnapshot } 
    from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";
    const firebaseConfig = {
        apiKey: "AIzaSyDrI9vIDUePbzHrTSRCKAcJ7oCfCIrSIUI",
        authDomain: "apps-a5358.firebaseapp.com",
        projectId: "apps-a5358",
        storageBucket: "apps-a5358.firebasestorage.app",
        messagingSenderId: "796844706882",
        appId: "1:796844706882:web:16b8e105ba28b1390971db",
        measurementId: "G-9TVN21KVF3"
    };
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const tranCol = collection(db, "inventory");
    window.cachedData = null, window.currentDocId = null;
    flatpickr(".date-input", { dateFormat: "d-m-Y", });
    onAuthStateChanged(auth, async (user) => {
        if (user) { 
            showCont('topbar'); 
            await fetchAllOnce();
            await loadDropdownData();
        } 
        else { document.getElementById("topbar").classList.add("hidden"); showCont("lgnCont"); } 
    });
    document.addEventListener('DOMContentLoaded', () => {
        const labelClass = "absolute top-2 left-0 px-2 text-gray-500 transform -translate-y-6 peer-placeholder-shown:translate-y-0 peer-placeholder-shown:scale-80 peer-focus:text-blue-600";
        document.querySelectorAll('label').forEach(label => { label.classList.add(...labelClass.split(' ')); });
        const inputClass = "peer w-full px-2 border-b-2 border-gray-500 bg-transparent pt-2 focus:outline-none focus:border-blue-600 pr-2";
        document.querySelectorAll('.input-box').forEach(input => {
            input.classList.add(...inputClass.split(' '));
            input.setAttribute('placeholder', ' ');
            input.setAttribute('autocomplete', 'off');
            if (input.tagName === "INPUT" && input.type === "text") {
                input.addEventListener('input', function () {
                    const start = this.selectionStart;
                    const end = this.selectionEnd;
                    this.value = this.value.toLowerCase().replace(/\b\w/g, char => char.toUpperCase());
                    this.setSelectionRange(start, end); 
                }); 
            } 
        }); 
    });                 
    document.getElementById('topbar').addEventListener('click', () => { document.getElementById('top-nav').classList.remove('-translate-y-full'); showCont(); });
    document.querySelectorAll('.menu-link').forEach(link => {
        link.addEventListener('click', e => {
            if (link.getAttribute('id') === 'close') { e.preventDefault(); }
            document.getElementById('top-nav').classList.add('-translate-y-full');
        });
    });
    
    window.fetchAllOnce = async function() {
        if (!window.cachedData) {
            const snapshot = await getDocs(collection(db, "inventory")); 
            window.cachedData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })); 
        }
        return window.cachedData;
    };

    window.clear = function () { document.querySelectorAll("input").forEach(el => el.value = ""); };
    
    window.showCont = function (...idToShow) {
        const allIds = ['lgnCont', 'suppCont', 'deptCont', 'catgCont', 'itemCont', 'delCont', 'tranCont', 'tblCont',];
        allIds.forEach(id => { const el = document.getElementById(id); if (el) { el.classList.add("hidden"); el.style.setProperty('display', 'none', 'important'); } });
        idToShow.forEach(id => { const el = document.getElementById(id); if (el) { el.classList.remove("hidden"); el.style.setProperty('display', 'block', 'important'); } }); 
    };
    
    window.loadDropdownData = async function () {
        const dropData = await fetchAllOnce();
        const suppSet = new Set();
        const catgSet = new Set();
        const deptSet = new Set();
        const itemSet = new Set();
        const selectedCatg = document.getElementById("catg1").value.trim();
        dropData.forEach((data) => {
            const mgrp = (data.mgrp || "").trim();
            const grp = (data.grp || "").trim();
            const name = (data.name || "").trim();
            if (grp === "Supplier" && name.length > 0) {suppSet.add(name);}
            if (grp === "Department" && name.length > 0) {deptSet.add(name);}
            if (mgrp === "Category" && grp.length > 0) {catgSet.add(grp);}
            if (selectedCatg && grp === selectedCatg && name.length > 0) { itemSet.add(name); }
        });
        window.supplst = [...suppSet].sort((a, b) => a.localeCompare(b));
        window.catglst = [...catgSet].sort((a, b) => a.localeCompare(b));
        window.deptlst = [...deptSet].sort((a, b) => a.localeCompare(b));
        window.itemlst = [...itemSet].sort((a, b) => a.localeCompare(b));
        attachDropdown(document.getElementById("catggrp"), window.catglst);
        attachDropdown(document.getElementById("supp1"), window.supplst);
        attachDropdown(document.getElementById("catg1"), window.catglst);
        attachDropdown(document.getElementById("dept1"), window.deptlst);
        attachDropdown(document.getElementById("item1"), window.itemlst);
    };
    window.attachDropdown = function (inputElement, dataList) {
        if (inputElement._dropdownCleanup) { inputElement._dropdownCleanup(); }
        let wrapper = inputElement.parentElement;
        if (!wrapper.classList.contains("relative")) {
            wrapper = document.createElement("div");
            wrapper.className = "relative w-full";
            inputElement.parentNode.insertBefore(wrapper, inputElement);
            wrapper.appendChild(inputElement);
        }
        let dropdown = document.createElement("ul");
        dropdown.className = "absolute z-50 w-full max-h-100 overflow-y-auto bg-gray-800 border border-green-600 rounded-md hidden";
        wrapper.appendChild(dropdown);

        function filterList() {
            const search = inputElement.value.toLowerCase();
            const matches = dataList.filter(item => item.toLowerCase().includes(search));
            populateDropdown(matches);
        }
        function populateDropdown(list) {
            dropdown.innerHTML = "";
            list.forEach(item => {
                const li = document.createElement("li");
                li.textContent = item;
                li.className = "px-2 py-2 hover:bg-gray-700 cursor-pointer";
                li.addEventListener('mousedown', (e) => { e.preventDefault(); inputElement.value = item; dropdown.classList.add("hidden"); });
                dropdown.appendChild(li);
            });
        }
        const onInput = () => { dropdown.classList.remove("hidden"); filterList(); };
        const onClick = () => { dropdown.classList.remove("hidden"); filterList(); };
        const onBlur = () => {
            setTimeout(() => {
                const value = inputElement.value.trim().toLowerCase();
                if (value && !dataList.some(item => item.toLowerCase() === value)) { alert("Please select a valid option from the list."); inputElement.value = ""; return; }
            }, 200);
        };
        const onDocClick = (e) => { if (!wrapper.contains(e.target)) dropdown.classList.add("hidden"); };
        inputElement.addEventListener("input", onInput);
        inputElement.addEventListener("click", onClick);
        inputElement.addEventListener("blur", onBlur);
        document.addEventListener("click", onDocClick);

        inputElement._dropdownCleanup = () => {
            inputElement.removeEventListener("input", onInput);
            inputElement.removeEventListener("click", onClick);
            inputElement.removeEventListener("blur", onBlur);
            document.removeEventListener("click", onDocClick);
            if (dropdown.parentNode) dropdown.parentNode.removeChild(dropdown);
            inputElement._dropdownCleanup = null;
        };
    };
    
    window.createEditableTable = function (rows, columns, showDelete = true, showUpdate = true, editable = false) {
        if (window.table && typeof window.table.destroy === "function") window.table.destroy();
        const searchId = document.getElementById('searchBox');
        const fullColumns = columns.map(col => ({...col, editor: editable ? col.editor || "input" : false,}));
        if (showDelete) {
            fullColumns.push({
                title: "",
                field: "__delete",
                formatter: () => `<div class="text-center cursor-pointer">‚õî</div>`,
                width: 70,
                hozAlign: "center",
                cellClick: async (e, cell) => {
                    e.stopPropagation();
                    const rowData = cell.getRow().getData();
                    const confirmed = confirm("Delete? Are You Sure?");
                    if (confirmed && rowData.id) {
                        await deleteDoc(doc(db, "gopal", rowData.id));
                        cell.getRow().delete(); 
                        if (window.cachedData) { window.cachedData = window.cachedData.filter(doc => doc.id !== rowData.id); }
                    } 
                }, 
            }); 
        }
        if (showUpdate) {
            fullColumns.push({
                title: "",
                field: "__update",
                formatter: () => `<div class="text-center cursor-pointer">‚úèÔ∏è</div>`,
                width: 70,
                hozAlign: "center",
                cellClick: (e, cell) => {
                    e.stopPropagation();
                    const rowData = cell.getRow().getData();
                    window.currentDocId = rowData.id;
                    showTransactionContainer(rowData); 
                } 
            }); 
        }
        window.table = new Tabulator(document.getElementById('table'), {
            data: rows,
            layout: "fitDataTable",
            reactiveData: true,
            rowHeight: 40,
            maxHeight: "600px",
            columns: fullColumns, 
        });
        document.getElementById('excelBtn')?.addEventListener("click", () => { window.table.download("xlsx", "data.xlsx", {sheetName: "Sheet1"}); });
        document.getElementById('pdfBtn')?.addEventListener("click", () => { window.table.download("pdf", "data.pdf", {orientation: "portrait"}); });
        document.getElementById('printBtn')?.addEventListener("click", () => { window.table.print(false, true); });
        bindSearch(); 
    };
    window.bindSearch = function () {
        const searchbox = document.getElementById("searchBox");
        searchbox.addEventListener("input", function () {
            const value = this.value.toLowerCase().trim();
            table.setFilter(function (data) {
                if (value === "") { return true; }
                return Object.values(data).some(val => String(val).toLowerCase().includes(value)); 
            }); 
        }); 
    };

    window.saveCDSI = async function(type) {
        let name = "", grp = "";
        if (type === "suppname") { name = document.getElementById("suppname").value.trim(); grp = "Supplier"; if (!name) return alert('Supplier Name is required.'); } 
        if (type === "deptname") { name = document.getElementById("deptname").value.trim(); grp = "Department"; if (!name) return alert('Department Name is required.'); } 
        if (type === "catgname") { grp = document.getElementById("catgname").value.trim(); if (!grp) return alert('Category Name is required.'); }
        if (type === "itemname") { name = document.getElementById("itemname").value.trim(); grp = document.getElementById("catggrp").value.trim(); if (!grp || !name) return alert('Category & Item Name are required.'); } 
        const loc = document.getElementById("loc").value.trim();
        const newDocData = { grp, ...(name ? { name } : {}) };
        if (loc) newDocData.loc = loc;
        if (type === "catgname") newDocData.mgrp = "Category";
        const docRef = await addDoc(tranCol, newDocData);
        const savedData = { id: docRef.id, ...newDocData };
        window.cachedData.push(savedData);
        await loadDropdownData();
        showCont('tranCont');
    };
    window.insertTran = async function (showDelete = true, showUpdate = true, editable = false) {
        const data = await fetchAllOnce();
        const rows = [];
        data.forEach(item => {
            if (!item.date) return;
            rows.push({
                id: item.id,
                date: item.date.split('-').reverse().join('-').replace(/(\d{2})-(\d{4})$/, '$1-$2'),
                ttype: item.ttype, 
                supp: item.supp || "",
                dept: item.dept || "", 
                catg: item.catg || "", 
                item: item.item || "", 
                price: item.price || "",
                qty: item.qty || "", 
                nar: item.nar || "", 
            }); 
        });
        const columns = [
            {title: "Date", field: "date"}, 
            {title: "Type", field: "ttype"}, 
            {title: "Supplier", field: "supp"}, 
            {title: "Department", field: "dept"},  
            {title: "Category", field: "catg"}, 
            {title: "Items", field: "item"},
            {title: "Price", field: "price", hozAlign: "right"}, 
            {title: "Qty", field: "qty", hozAlign: "right"},
            {title: "Narration", field: "nar"}, 
            {title: "ID", field: "id", visible: false} 
        ];
        createEditableTable(rows, columns, showDelete, showUpdate, editable);
        showCont("tblCont"); 
    };
    
    window.showTransactionContainer = function (rowData) { 
        const fieldDivs = ['dateDiv','suppDiv','deptDiv','catgDiv','itemDiv','pricDiv','qtyDiv','narDiv','btnDiv'];
        document.getElementById("ttype1").value = rowData.ttype || "";
        const ttype = document.getElementById("ttype1").value
        const dateInput = document.getElementById("date1");
        if (dateInput._flatpickr) { dateInput._flatpickr.setDate(rowData.date || "", true);};
        document.getElementById("catg1").value = rowData.catg || "";
        document.getElementById("item1").value = rowData.item || "";
        document.getElementById("qty1").value = rowData.qty || "";
        document.getElementById("nar1").value = rowData.nar || "";
        fieldDivs.forEach(id => {
            const div = document.getElementById(id);
            if (ttype === 'In') {
                if (id === 'deptDiv') div.style.display = 'none';
                else div.style.display = '';
                document.getElementById("supp1").value = rowData.supp || "";
                document.getElementById("pric1").value = rowData.price || "";
            } else if (ttype === 'Out') {
                if (id === 'suppDiv' || id === 'pricDiv') div.style.display = 'none';
                else div.style.display = '';
                document.getElementById("dept1").value = rowData.dept || "";
            } else { div.style.display = 'none'; }
        });
        showCont('tranCont');
    };
   
    window.saveTran = async function () {
        const fields = ['ttype1','date1','supp1','dept1','catg1','item1','pric1','qty1','nar1'];    
        const values = {};
        fields.forEach(id => { const el = document.getElementById(id); values[id] = el ? el.value.trim() : ""; });
        const required = ['ttype1','date1','catg1','item1','qty1'];
        for (const r of required) { if (!values[r]) { return alert('Transaction Type, Date, Category, Item, Qty are required.'); } }
        const date = date1._flatpickr.formatDate( date1._flatpickr.parseDate(values.date1, "d-m-Y"), "Y-m-d" );
        const tranData = { ttype: values.ttype1, date: date, catg: values.catg1, item: values.item1, qty: Number(values.qty1), };
        if (values.supp1) tranData.supp = values.supp1;
        if (values.dept1) tranData.dept = values.dept1;
        if (values.pric1) tranData.price = Number(values.pric1);
        if (values.nar1) tranData.nar = values.nar1;

        if (window.currentDocId) { 
            const docRef = doc(db, "inventory", window.currentDocId); 
            await updateDoc(docRef, tranData); 
            const index = window.cachedData.findIndex(item => item.id === docRef.id);
            if (index !== -1) { window.cachedData[index] = { ...window.cachedData[index], ...tranData }; }
            insertTran();
        } 
        else { 
            const newDocRef = await addDoc(collection(db, "inventory"), tranData); 
            window.cachedData.push({ id: newDocRef.id, ...tranData });
        }
        clear(); window.currentDocId = null; window.onload();
    };

    window.viewStock = async function () {
        const data = await fetchAllOnce();
        const stockMap = {};
        data.forEach(item => {
            const key = item.item || "Unknown";
            const qty = Number(item.qty) || 0;
            if (!stockMap[key]) stockMap[key] = { in: 0, out: 0 };
            if (item.ttype?.toLowerCase() === "in") { stockMap[key].in += qty; } 
            else if (item.ttype?.toLowerCase() === "out") { stockMap[key].out += qty; }
        });
        const stockRows = Object.entries(stockMap).map(([item, q]) => ({ item, inqty: q.in, outqty: q.out, stock: q.in - q.out, }));
        const stockColumns = [ {title: "Item", field: "item"}, {title: "In", field: "inqty", hozAlign: "right"}, {title: "Out", field: "outqty", hozAlign: "right"}, {title: "Stock", field: "stock", hozAlign: "right"}, ];
        createEditableTable(stockRows, stockColumns, false, false, false);
        showCont("tblCont"); 
    };

    window.viewDeptCons = async function () {
        const data = await fetchAllOnce();
        const deptMap = {};
        data.forEach(item => {
            if (item.ttype?.toLowerCase() !== "out") return;
            const dept = item.dept || "Unknown Dept";
            const itm  = item.item || "Unknown Item";
            const qty  = Number(item.qty) || 0;
            if (!deptMap[dept]) deptMap[dept] = {};
            if (!deptMap[dept][itm]) deptMap[dept][itm] = 0;
            deptMap[dept][itm] += qty;
        });
        const rows = [];
        Object.entries(deptMap).forEach(([dept, items]) => { Object.entries(items).forEach(([itm, qty]) => { rows.push({ dept, item: itm, qty }); }); });
        const columns = [ {title: "Department", field: "dept"}, {title: "Item", field: "item"}, {title: "Consumed Qty", field: "qty", hozAlign: "right"}, ];
        createEditableTable(rows, columns, false, false, false);
        showCont("tblCont");
    };

    window.viewCatgwiseStock = async function () {
        const data = await fetchAllOnce();
        const catgMap = {};
        data.forEach(item => {
            const catg = item.catg || "Unknown Category";
            const qty  = Number(item.qty) || 0;
            if (!catgMap[catg]) catgMap[catg] = { in: 0, out: 0 };
            if (item.ttype?.toLowerCase() === "in") { catgMap[catg].in += qty; } else if (item.ttype?.toLowerCase() === "out") { catgMap[catg].out += qty; }
        });
        const rows = Object.entries(catgMap).map(([catg, q]) => ({ category: catg, inqty: q.in, outqty: q.out, stock: q.in - q.out, }));
        const columns = [ {title: "Category", field: "category"}, {title: "In Qty", field: "inqty", hozAlign: "right"}, {title: "Out Qty", field: "outqty", hozAlign: "right"}, {title: "Stock", field: "stock", hozAlign: "right"}, ];
        createEditableTable(rows, columns, false, false, false);
        showCont("tblCont");
    };

    window.onload = () => {
        const fieldDivs = ['dateDiv','suppDiv','deptDiv','catgDiv','itemDiv','pricDiv','qtyDiv','narDiv','btnDiv'];
        fieldDivs.forEach(id => document.getElementById(id).style.display = 'none');
        document.getElementById('ttype1').addEventListener('input', () => {
            document.querySelectorAll("input:not(#ttype1)").forEach(el => el.value = "");
            const ttype = document.getElementById('ttype1').value;
            fieldDivs.forEach(id => {
                const div = document.getElementById(id);
                if (ttype === 'In') {
                    if (id === 'deptDiv') div.style.display = 'none';
                    else div.style.display = '';
                } else if (ttype === 'Out') {
                    if (id === 'suppDiv' || id === 'pricDiv') div.style.display = 'none';
                    else div.style.display = '';
                } else { div.style.display = 'none'; }
            });
        });
    };
    document.getElementById("catg1").addEventListener("blur", () => { document.getElementById("item1").value = ""; loadDropdownData(); });
    window.login = async function () {
        const email = document.getElementById("loginEmail").value;
        const password = document.getElementById("loginPassword").value;
        const userCredential = await signInWithEmailAndPassword(auth, email, password);
        const user = userCredential.user;
        const docRef = doc(db, "users", user.uid);
        const docSnap = await getDoc(docRef);
        if (docSnap.exists() && docSnap.data().approved === true) { showCont("topbar"); }
    };
    window.logout = async function () { await signOut(auth); showCont("lgnCont"); };
    //window.addEventListener("beforeunload", function (e) { e.preventDefault(); e.returnValue = ""; });
</script>
</body>

</html>
